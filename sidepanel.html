<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Architecture Validation</title>
  <script src="https://www.gstatic.com/meetjs/addons/1.2.0/meet.addons.js"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #1a1a2e;
      color: #e0e0e0;
      padding: 16px;
      margin: 0;
      font-size: 14px;
    }
    h1 { font-size: 16px; color: #8888cc; }
    .status {
      margin: 8px 0;
      padding: 8px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
    .ok { background: #1a3a1a; border: 1px solid #2d5a2d; }
    .fail { background: #3a1a1a; border: 1px solid #5a2d2d; }
    .pending { background: #2a2a1a; border: 1px solid #4a4a2d; }
    .info { background: #1a2a3a; border: 1px solid #2d4a5a; }
    button {
      background: #3a3a6a;
      color: #e0e0e0;
      border: 1px solid #5a5a8a;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 4px;
    }
    button:hover { background: #4a4a7a; }
    #log {
      margin-top: 12px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 11px;
      padding: 8px;
      background: #0a0a1a;
      border-radius: 4px;
    }
    .log-entry { margin: 2px 0; }
    .log-ok { color: #6a6; }
    .log-fail { color: #a66; }
    .log-info { color: #88a; }
  </style>
</head>
<body>
  <h1>Architecture Validation v2</h1>

  <div id="context" class="status info">Checking environment...</div>

  <div id="step1" class="status pending">1. createAddonSession — waiting...</div>
  <div id="step2" class="status pending">2. createSidePanelClient — waiting...</div>
  <div id="stepB" class="status pending">B. getMeetingInfo — waiting...</div>
  <div id="stepWS" class="status pending">WS. WebSocket connectivity — waiting...</div>
  <div id="stepFB" class="status pending">FB. Firebase SDK load — waiting...</div>

  <div style="margin-top: 12px;">
    <button onclick="runAllTests()">Run All Tests</button>
  </div>

  <div id="log"></div>

  <script>
    const CLOUD_PROJECT_NUMBER = '1430218413';

    let session = null;
    let sidePanelClient = null;

    function log(msg, type) {
      type = type || 'info';
      var el = document.getElementById('log');
      var entry = document.createElement('div');
      entry.className = 'log-entry log-' + type;
      entry.textContent = '[' + new Date().toISOString().slice(11, 19) + '] ' + msg;
      el.appendChild(entry);
      el.scrollTop = el.scrollHeight;
    }

    function setStep(n, status, msg) {
      var el = document.getElementById(n);
      if (el) {
        el.className = 'status ' + status;
        el.textContent = msg;
      }
    }

    async function runAllTests() {
      // Step 1: Create addon session
      if (!session) {
        try {
          log('Creating addon session...');
          session = await window.meet.addon.createAddonSession({
            cloudProjectNumber: CLOUD_PROJECT_NUMBER,
          });
          setStep('step1', 'ok', '1. createAddonSession — SUCCESS');
          log('Session created', 'ok');
        } catch (err) {
          setStep('step1', 'fail', '1. createAddonSession — FAILED: ' + (err.message || err));
          log('Session failed: ' + (err.message || err), 'fail');
          return;
        }
      }

      // Step 2: Create side panel client
      if (!sidePanelClient) {
        try {
          sidePanelClient = await session.createSidePanelClient();
          setStep('step2', 'ok', '2. createSidePanelClient — SUCCESS');
          log('SidePanelClient created', 'ok');

          var methods = [];
          for (var key in sidePanelClient) {
            methods.push(key + '(' + typeof sidePanelClient[key] + ')');
          }
          log('Methods: ' + methods.join(', '), 'info');
        } catch (err) {
          setStep('step2', 'fail', '2. createSidePanelClient — FAILED: ' + err.message);
          log('SidePanelClient failed: ' + err.message, 'fail');
        }
      }

      // Test B: getMeetingInfo
      if (sidePanelClient) {
        try {
          log('Calling getMeetingInfo()...');
          if (typeof sidePanelClient.getMeetingInfo === 'function') {
            var info = await sidePanelClient.getMeetingInfo();
            log('getMeetingInfo returned: ' + JSON.stringify(info), 'ok');
            var details = '';
            for (var k in info) {
              details += k + '=' + JSON.stringify(info[k]) + ' ';
            }
            setStep('stepB', 'ok', 'B. getMeetingInfo — ' + details);
          } else {
            log('getMeetingInfo not available on sidePanelClient', 'fail');
            setStep('stepB', 'fail', 'B. getMeetingInfo — method not found');
            // Check session
            if (session && typeof session.getMeetingInfo === 'function') {
              var info2 = await session.getMeetingInfo();
              log('Found on session: ' + JSON.stringify(info2), 'ok');
              setStep('stepB', 'ok', 'B. getMeetingInfo (session) — ' + JSON.stringify(info2));
            }
          }
        } catch (err) {
          setStep('stepB', 'fail', 'B. getMeetingInfo — FAILED: ' + err.message);
          log('getMeetingInfo error: ' + err.message, 'fail');
        }
      }

      // Test WS: WebSocket connectivity
      try {
        log('Testing WebSocket to wss://ws.postman-echo.com/raw ...');
        var wsResult = await testWebSocket('wss://ws.postman-echo.com/raw');
        setStep('stepWS', 'ok', 'WS. WebSocket — SUCCESS: ' + wsResult);
        log('WebSocket works: ' + wsResult, 'ok');
      } catch (err) {
        setStep('stepWS', 'fail', 'WS. WebSocket — BLOCKED: ' + err.message);
        log('WebSocket blocked: ' + err.message, 'fail');
      }

      // Test FB: Firebase SDK load
      try {
        log('Loading Firebase SDK...');
        await loadScript('https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js');
        if (typeof firebase !== 'undefined') {
          setStep('stepFB', 'ok', 'FB. Firebase SDK — LOADED v' + (firebase.SDK_VERSION || '?'));
          log('Firebase loaded: ' + (firebase.SDK_VERSION || '?'), 'ok');
          await loadScript('https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js');
          log('Firebase database module also loaded', 'ok');
        } else {
          setStep('stepFB', 'fail', 'FB. Firebase SDK — global missing');
        }
      } catch (err) {
        setStep('stepFB', 'fail', 'FB. Firebase SDK — BLOCKED: ' + err.message);
        log('Firebase load failed: ' + err.message, 'fail');
      }

      log('=== All tests complete ===', 'ok');
    }

    function testWebSocket(url) {
      return new Promise(function(resolve, reject) {
        var timeout = setTimeout(function() {
          ws.close();
          reject(new Error('timeout'));
        }, 5000);

        var ws;
        try {
          ws = new WebSocket(url);
        } catch (err) {
          clearTimeout(timeout);
          reject(err);
          return;
        }

        ws.onopen = function() {
          log('WS connected', 'ok');
          ws.send('ping-from-meet');
        };

        ws.onmessage = function(event) {
          clearTimeout(timeout);
          ws.close();
          resolve(String(event.data).substring(0, 80));
        };

        ws.onerror = function() {
          clearTimeout(timeout);
          reject(new Error('WS error'));
        };

        setTimeout(function() {
          if (ws.readyState === WebSocket.OPEN) {
            clearTimeout(timeout);
            ws.close();
            resolve('connected (no echo)');
          }
        }, 3000);
      });
    }

    function loadScript(src) {
      return new Promise(function(resolve, reject) {
        var script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = function() { reject(new Error('Script blocked: ' + src)); };
        document.head.appendChild(script);
      });
    }

    // Auto-init
    window.addEventListener('DOMContentLoaded', function() {
      var contextEl = document.getElementById('context');
      var inIframe = false;
      try { inIframe = window.self !== window.top; } catch(e) { inIframe = true; }
      var onMeetDomain = document.referrer.indexOf('meet.google.com') !== -1;

      if (inIframe && onMeetDomain) {
        contextEl.className = 'status ok';
        contextEl.textContent = 'Running inside Google Meet iframe';
        log('Environment: Meet iframe', 'ok');
        runAllTests();
      } else if (inIframe) {
        contextEl.className = 'status info';
        contextEl.textContent = 'In iframe (not Meet)';
      } else {
        contextEl.className = 'status info';
        contextEl.textContent = 'Standalone — open from Meet to run SDK tests';
        log('Standalone mode. Click button to run network-only tests.', 'info');
      }
    });
  </script>
</body>
</html>
